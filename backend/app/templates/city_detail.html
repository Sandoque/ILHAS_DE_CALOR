{% extends 'base.html' %}
{% block content %}
<section class="flex flex-col gap-4 mb-8">
  <div class="flex flex-col gap-2">
    <h1 class="text-2xl font-bold">Estação {{ station_code }}</h1>
    <p class="text-slate-600">Monitoramento local e análise de risco</p>
  </div>
  <div class="grid gap-4 md:grid-cols-4">
    <div class="card" hx-get="/api/climate/station/{{ station_code }}/daily?limit=1" hx-trigger="load" hx-swap="none" data-daily-metric="max24"><div id="max24">{% include 'components/card_metric.html' with context %}</div></div>
    <div class="card" hx-get="/api/climate/station/{{ station_code }}/daily?limit=1" hx-trigger="load" hx-swap="none" data-daily-metric="min24"><div id="min24">{% include 'components/card_metric.html' with context %}</div></div>
    <div class="card" hx-get="/api/climate/station/{{ station_code }}/daily?limit=1" hx-trigger="load" hx-swap="none" data-daily-metric="heatindex"><div id="heatindex">{% include 'components/card_metric.html' with context %}</div></div>
    <div class="card" hx-get="/api/climate/station/{{ station_code }}/daily?limit=1" hx-trigger="load" hx-swap="none" data-daily-metric="amplitude"><div id="amplitude">{% include 'components/card_metric.html' with context %}</div></div>
  </div>
</section>

<section class="grid gap-6 lg:grid-cols-3 mb-10">
  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between mb-4">
      <h2 class="section-title">Temperatura vs Índice de Calor (7 dias)</h2>
    </div>
    <div id="temp-heat-chart" class="h-80">{% include 'components/chart_loader.html' %}</div>
  </div>
  <aside class="card flex flex-col gap-2">
    <h3 class="text-lg font-semibold">Metadados</h3>
    <dl class="grid grid-cols-2 gap-2 text-sm text-slate-700">
      <dt class="font-medium">UF</dt><dd id="meta-uf">--</dd>
      <dt class="font-medium">Altitude</dt><dd id="meta-altitude">--</dd>
      <dt class="font-medium">Latitude</dt><dd id="meta-latitude">--</dd>
      <dt class="font-medium">Longitude</dt><dd id="meta-longitude">--</dd>
    </dl>
  </aside>
</section>

<section class="grid gap-6 lg:grid-cols-3 mb-10">
  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between mb-4">
      <h2 class="section-title">Precipitação (7 dias)</h2>
    </div>
    <div id="precip-chart" class="h-64">{% include 'components/chart_loader.html' %}</div>
  </div>
  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <h2 class="section-title">Série diária</h2>
    </div>
    <div hx-get="/api/climate/station/{{ station_code }}/daily?limit=7" hx-trigger="load" hx-swap="none" id="daily-loader">
      <div id="daily-table" class="text-sm text-slate-500 animate-pulse">Carregando...</div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const stationCode = "{{ station_code }}";
    const dailyUrl = `/api/climate/station/${stationCode}/daily?limit=7`;
    try {
      const resp = await fetch(dailyUrl);
      const json = await resp.json();
      const data = json.data || [];
      const dates = data.map(d => d.date).reverse();
      renderTempHeatLineChart('temp-heat-chart', dates, data.map(d => d.avg_temp || d.max_temp), data.map(d => d.heat_index_max));
      renderPrecipBarChart('precip-chart', dates, data.map(d => d.precipitation_total));
    } catch (err) {
      console.error('Erro ao carregar gráficos', err);
    }

    const stationResp = await fetch(`/api/stations/${stationCode}`);
    if (stationResp.ok) {
      const { data } = await stationResp.json();
      if (data) {
        document.getElementById('meta-uf').textContent = data.uf || '--';
        document.getElementById('meta-altitude').textContent = data.altitude || '--';
        document.getElementById('meta-latitude').textContent = data.latitude || '--';
        document.getElementById('meta-longitude').textContent = data.longitude || '--';
      }
    }
  });
</script>
{% endblock %}
